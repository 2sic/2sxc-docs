
# Changes to the Dev Environment in v21.00

## Web.Config Changes

In v21.00 we changed `System.Diagnostics.DiagnosticSource` to use .net 9.

Because of this, the `web.config` must in DNN change.
When people install 2sxc, this happens automatically, but not in a dev-environment.

These are the new values you need - make sure you comment out the old versions:

```xml
<!-- Old version:
<dependentAssembly xmlns="urn:schemas-microsoft-com:asm.v1">
  <assemblyIdentity name="System.Diagnostics.DiagnosticSource" publicKeyToken="cc7b13ffcd2ddd51" />
  <bindingRedirect oldVersion="0.0.0.0-32767.32767.32767.32767" newVersion="4.0.3.0" />
</dependentAssembly>
-->
<dependentAssembly xmlns="urn:schemas-microsoft-com:asm.v1">
  <assemblyIdentity name="System.Diagnostics.DiagnosticSource" publicKeyToken="cc7b13ffcd2ddd51" />
  <bindingRedirect oldVersion="0.0.0.0-32767.32767.32767.32767" newVersion="9.0.0.11" />
</dependentAssembly>
```

## Database Changes

In v21.00 we introduce DB changes which are required for:

1. **Undelete support** (track deletes so items can be restored later)
2. **Relationships to external data and deleted data**

> [!WARNING]
> Always create a DB backup before running migration scripts.

### Run the SQL upgrade script

This will

1. Add a `ParentRef` column to the `TsDynDataHistory` table to link history records to their parent App or content item.
2. Add a `ChildExternalId` column to the `TsDynDataRelationship` table to support relationships to external data and deleted data.
3. Remove the short-lived `TransDeletedId` column (and related FK/index) from the `TsDynDataRelationship` table if it exists from earlier experiments.

You can copy/paste it into SQL Server Management Studio (SSMS) and execute it against your dev database.

```sql
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

-- make sure sql rolls back automatically in case of error.
SET XACT_ABORT ON
GO

-- =====================================================================
-- Ensure TsDynDataHistory exists and has ParentRef (eg. "app-42")
-- =====================================================================

-- Add ParentRef column on existing installations
IF NOT EXISTS (SELECT * FROM sys.columns WHERE Name = N'ParentRef' AND Object_ID = OBJECT_ID(N'[dbo].[TsDynDataHistory]'))
	AND OBJECT_ID('[dbo].[TsDynDataHistory]', 'U') IS NOT NULL
BEGIN
	PRINT '... Adding column [ParentRef] to [dbo].[TsDynDataHistory]';
	ALTER TABLE [dbo].[TsDynDataHistory] ADD [ParentRef] [nvarchar](250) NULL;
END

-- Add indexes for ParentRef
IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_TsDynDataHistory_ParentRef' AND object_id = OBJECT_ID('[dbo].[TsDynDataHistory]'))
	AND OBJECT_ID('[dbo].[TsDynDataHistory]', 'U') IS NOT NULL
BEGIN
	PRINT '... Adding index IX_TsDynDataHistory_ParentRef';
	CREATE NONCLUSTERED INDEX [IX_TsDynDataHistory_ParentRef] ON [dbo].[TsDynDataHistory] ([ParentRef] ASC)
	WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];
END

-- =====================================================================
-- TsDynDataRelationship: add ChildExternalId to support undelete
-- =====================================================================

-- Add ChildExternalId column on existing installations
IF NOT EXISTS (SELECT * FROM sys.columns WHERE Name = N'ChildExternalId' AND Object_ID = OBJECT_ID(N'[dbo].[TsDynDataRelationship]'))
	AND OBJECT_ID('[dbo].[TsDynDataRelationship]', 'U') IS NOT NULL
BEGIN
	PRINT '... Adding column [ChildExternalId] to [dbo].[TsDynDataRelationship]';
	ALTER TABLE [dbo].[TsDynDataRelationship] ADD [ChildExternalId] [uniqueidentifier] NULL;
END

-- Remove TransDeletedId (was a short-lived experiment)
IF OBJECT_ID('[dbo].[TsDynDataRelationship]', 'U') IS NOT NULL
BEGIN
	IF EXISTS (
		SELECT *
		FROM sys.foreign_keys
		WHERE name = 'FK_TsDynDataRelationship_TsDynDataTransactionDeleted'
		  AND parent_object_id = OBJECT_ID('[dbo].[TsDynDataRelationship]')
	)
	BEGIN
		PRINT '... Dropping FK FK_TsDynDataRelationship_TsDynDataTransactionDeleted';
		ALTER TABLE [dbo].[TsDynDataRelationship] DROP CONSTRAINT [FK_TsDynDataRelationship_TsDynDataTransactionDeleted];
	END

	IF EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_TsDynDataRelationship_TransDeletedId' AND object_id = OBJECT_ID('[dbo].[TsDynDataRelationship]'))
	BEGIN
		PRINT '... Dropping index IX_TsDynDataRelationship_TransDeletedId';
		DROP INDEX [IX_TsDynDataRelationship_TransDeletedId] ON [dbo].[TsDynDataRelationship];
	END

	IF EXISTS (SELECT * FROM sys.columns WHERE Name = N'TransDeletedId' AND Object_ID = OBJECT_ID(N'[dbo].[TsDynDataRelationship]'))
	BEGIN
		PRINT '... Dropping column [TransDeletedId] from [dbo].[TsDynDataRelationship]';
		ALTER TABLE [dbo].[TsDynDataRelationship] DROP COLUMN [TransDeletedId];
	END
END

GO
```

---

## History

* 2025-12-15 `web.config` originally for v20.00.10, but now for v21.00.
* 2025-12-16 v21.00: Add `ParentRef` to `TsDynDataHistory` and `ChildExternalId` to `TsDynDataRelationship`.
* 2025-12-18 v21.00: Remove `TransDeletedId` (and related FK/index) from `TsDynDataRelationship`.
